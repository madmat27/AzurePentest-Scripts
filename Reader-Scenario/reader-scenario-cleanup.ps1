$starttime = Get-Date
Write-Host -ForegroundColor Green "Cleanup Started $starttime"

## Set the user and service principal names
$upnsuffix=$(az ad signed-in-user show --query userPrincipalName --output tsv | sed 's/.*@//')
$user = "reader@$upnsuffix"
$group = "pentesting-resgr-rea"
$customappname = "customapp"
$containerappname = "containerapp"

## Get the app id and user id
$userid=$(az ad user show --id $user | jq -r .id)
$customappid=$(az ad app list --display-name $customappname --query [].appId -o tsv)
$containerappid=$(az ad app list --display-name $containerappname --query [].appId -o tsv)  

## Clean up role assignments
Write-Host -ForegroundColor Green "##############################################################"
Write-Host -ForegroundColor Green "# Cleaning up resource group #"
Write-Host -ForegroundColor Green "##############################################################"
az group delete -n $group --yes

Write-Host -ForegroundColor Green "###############################################################"
Write-Host -ForegroundColor Green "# Deleting apps #"
Write-Host -ForegroundColor Green "###############################################################"
az ad app delete --id $customappid
az ad app delete --id $containerappid

Write-Host -ForegroundColor Green "###############################################################"
Write-Host -ForegroundColor Green "# Deleting user #"
Write-Host -ForegroundColor Green "###############################################################"
az ad user delete --id $userid

Write-Host -ForegroundColor Green "Successfully cleaned up resources!!"